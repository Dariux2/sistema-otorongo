<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación - Centro Oftalmológico El Otorongo</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="dashboard-page">
    <!-- Header del Dashboard -->
    <header class="dashboard-header-main">
        <div class="container">
            <div class="dashboard-brand">
                <i class="fas fa-eye"></i>
                <h1>Centro Oftalmológico El Otorongo</h1>
            </div>
            
            <div class="dashboard-user-info">
                <div class="user-welcome">
                    <span class="user-greeting">Bienvenido,</span>
                    <span class="user-name" id="userName">Usuario</span>
                    <span class="user-role" id="userRole">Rol</span>
                </div>
                <div class="user-actions">
                    <button class="btn-notification" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">0</span>
                    </button>
                    <button class="btn-profile" onclick="showProfile()">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegación Principal -->
    <nav class="dashboard-nav">
        <div class="container">
            <ul class="nav-menu" id="dashboardMenu">
                <!-- El menú se carga dinámicamente según el rol -->
            </ul>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="dashboard-main">
        <div class="container">
            <!-- Header de la página -->
            <div class="page-header">
                <div class="page-title">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Sistema de Facturación</h2>
                    <p>Genere y administre facturas de servicios médicos</p>
                </div>
                <div class="page-actions">
                    <button class="btn-primary" onclick="openModal('newInvoiceModal')">
                        <i class="fas fa-plus"></i> Nueva Factura
                    </button>
                    <button class="btn-secondary" onclick="exportInvoices()">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                </div>
            </div>

            <!-- Estadísticas de Facturación -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalInvoices">0</div>
                        <div class="stat-label">Total Facturas</div>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="paidInvoices">0</div>
                        <div class="stat-label">Facturas Pagadas</div>
                    </div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="pendingInvoices">0</div>
                        <div class="stat-label">Facturas Pendientes</div>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalRevenue">S/. 0.00</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                </div>
            </div>

            <!-- Lista de Facturas -->
            <div class="invoices-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Facturas Recientes</h3>
                        <div class="filter-controls">
                            <input type="text" id="searchInvoice" placeholder="Buscar por paciente o número..." onkeyup="filterInvoices()">
                            <select id="filterStatus" onchange="filterInvoices()">
                                <option value="">Todos los estados</option>
                                <option value="pagada">Pagada</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>N° Factura</th>
                                    <th>Fecha</th>
                                    <th>Paciente</th>
                                    <th>Servicios</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTableBody">
                                <!-- Las facturas se cargan dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Nueva Factura -->
    <div id="newInvoiceModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice"></i> Nueva Factura
                </h3>
                <button class="modal-close" onclick="closeModal('newInvoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newInvoiceForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="invoicePatient">
                                <i class="fas fa-user"></i> Paciente *
                            </label>
                            <select id="invoicePatient" name="pacienteId" required onchange="loadPatientInfo()">
                                <option value="">Seleccione un paciente</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="invoiceDate">
                                <i class="fas fa-calendar"></i> Fecha *
                            </label>
                            <input type="date" id="invoiceDate" name="fecha" required>
                        </div>

                        <div class="form-group full-width">
                            <div id="patientInfoDisplay" class="patient-info-card" style="display: none;">
                                <!-- Información del paciente se muestra aquí -->
                            </div>
                        </div>
                    </div>

                    <div class="services-section">
                        <div class="section-header">
                            <h4><i class="fas fa-list"></i> Servicios</h4>
                            <button type="button" class="btn-secondary btn-sm" onclick="addServiceRow()">
                                <i class="fas fa-plus"></i> Agregar Servicio
                            </button>
                        </div>
                        <div id="servicesContainer">
                            <!-- Los servicios se agregan dinámicamente -->
                        </div>
                    </div>

                    <div class="invoice-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotalAmount">S/. 0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>IGV (18%):</span>
                            <span id="igvAmount">S/. 0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span id="totalAmount">S/. 0.00</span>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="paymentMethod">
                                <i class="fas fa-credit-card"></i> Método de Pago *
                            </label>
                            <select id="paymentMethod" name="metodoPago" required>
                                <option value="">Seleccione</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="yape">Yape/Plin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="invoiceStatus">
                                <i class="fas fa-info-circle"></i> Estado *
                            </label>
                            <select id="invoiceStatus" name="estado" required>
                                <option value="pagada">Pagada</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="invoiceNotes">
                                <i class="fas fa-sticky-note"></i> Observaciones
                            </label>
                            <textarea id="invoiceNotes" name="observaciones" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Generar Factura
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('newInvoiceModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Factura -->
    <div id="viewInvoiceModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-invoice"></i> Detalle de Factura
                </h3>
                <button class="modal-close" onclick="closeModal('viewInvoiceModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoiceDetailsContent">
                    <!-- El contenido se carga dinámicamente -->
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="btn-success" onclick="downloadInvoicePDF()">
                        <i class="fas fa-file-pdf"></i> Descargar PDF
                    </button>
                    <button class="btn-secondary" onclick="sendInvoiceEmail()">
                        <i class="fas fa-envelope"></i> Enviar por Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let invoices = [];
        let patients = [];
        let services = [];
        let selectedInvoiceId = null;
        let serviceCounter = 0;

        // Servicios disponibles
        const availableServices = [
            { name: 'Consulta Oftalmológica', price: 80.00 },
            { name: 'Examen de Refracción', price: 50.00 },
            { name: 'Medición de Presión Intraocular', price: 40.00 },
            { name: 'Fondo de Ojo', price: 60.00 },
            { name: 'Cirugía de Cataratas', price: 2500.00 },
            { name: 'Cirugía de Pterigión', price: 1800.00 },
            { name: 'Lentes Correctivos', price: 150.00 },
            { name: 'Lentes de Contacto', price: 200.00 },
            { name: 'Control Post-Operatorio', price: 70.00 },
            { name: 'Emergencia Oftalmológica', price: 120.00 }
        ];

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            initializeInvoicingPage();
        });

        function initializeInvoicingPage() {
            if (!checkAuthentication()) return;
            loadUserData();
            setupRoleBasedMenu();
            loadPatients();
            loadInvoices();
            setupForms();
            setTodayDate();
            addServiceRow(); // Agregar primera fila de servicio
        }

        function checkAuthentication() {
            const savedUser = localStorage.getItem('otorongo_current_user');
            if (!savedUser) {
                showNotification('Sesión expirada. Redirigiendo al login...', 'warning');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return false;
            }
            currentUser = JSON.parse(savedUser);
            return true;
        }

        function loadUserData() {
            if (!currentUser) return;
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'administrador': 'Administrador',
                'medico': 'Médico',
                'recepcionista': 'Recepcionista'
            };
            return roleNames[role] || role;
        }

        function setupRoleBasedMenu() {
            const menuContainer = document.getElementById('dashboardMenu');
            const menus = {
                'administrador': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas' },
                    { icon: 'fas fa-file-invoice-dollar', text: 'Facturación', page: 'facturacion', active: true },
                    { icon: 'fas fa-chart-bar', text: 'Reportes', page: 'reportes' }
                ],
                'medico': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Mis Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Mis Citas', page: 'citas' },
                    { icon: 'fas fa-notes-medical', text: 'Historiales', page: 'historiales' }
                ],
                'recepcionista': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas' },
                    { icon: 'fas fa-file-invoice', text: 'Facturación', page: 'facturacion', active: true }
                ]
            };

            const userMenu = menus[currentUser.role] || menus['recepcionista'];
            
            menuContainer.innerHTML = userMenu.map(item => `
                <li>
                    <a href="${item.page}.html" class="nav-item ${item.active ? 'active' : ''}">
                        <i class="${item.icon}"></i>
                        <span>${item.text}</span>
                    </a>
                </li>
            `).join('');
        }

        function loadPatients() {
            patients = OtorongoSystem.getPatients();
            const select = document.getElementById('invoicePatient');
            select.innerHTML = '<option value="">Seleccione un paciente</option>' +
                patients.map(p => `<option value="${p.id}">${p.nombres} ${p.apellidos} - DNI: ${p.dni}</option>`).join('');
        }

        function loadInvoices() {
            invoices = OtorongoSystem.getInvoices();
            displayInvoices();
            updateStats();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
        }

        function setupForms() {
            const form = document.getElementById('newInvoiceForm');
            form.addEventListener('submit', handleNewInvoice);
        }

        function loadPatientInfo() {
            const patientId = document.getElementById('invoicePatient').value;
            const infoDisplay = document.getElementById('patientInfoDisplay');
            
            if (!patientId) {
                infoDisplay.style.display = 'none';
                return;
            }
            
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                infoDisplay.style.display = 'block';
                infoDisplay.innerHTML = `
                    <div class="patient-info-grid">
                        <div><strong>DNI:</strong> ${patient.dni}</div>
                        <div><strong>Teléfono:</strong> ${patient.telefono}</div>
                        <div><strong>Seguro:</strong> ${patient.seguro}</div>
                        <div><strong>Email:</strong> ${patient.email || 'No registrado'}</div>
                    </div>
                `;
            }
        }

        function addServiceRow() {
            serviceCounter++;
            const container = document.getElementById('servicesContainer');
            const row = document.createElement('div');
            row.className = 'service-row';
            row.id = `service-${serviceCounter}`;
            row.innerHTML = `
                <div class="service-inputs">
                    <select class="service-select" onchange="updateServicePrice(${serviceCounter})">
                        <option value="">Seleccione un servicio</option>
                        ${availableServices.map((s, i) => `<option value="${i}">${s.name} - S/. ${s.price.toFixed(2)}</option>`).join('')}
                    </select>
                    <input type="number" class="service-quantity" value="1" min="1" onchange="calculateTotal()" placeholder="Cant.">
                    <input type="number" class="service-price" step="0.01" min="0" onchange="calculateTotal()" placeholder="Precio">
                    <button type="button" class="btn-remove" onclick="removeServiceRow(${serviceCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(row);
        }

        function updateServicePrice(rowId) {
            const row = document.getElementById(`service-${rowId}`);
            const select = row.querySelector('.service-select');
            const priceInput = row.querySelector('.service-price');
            
            if (select.value !== '') {
                const service = availableServices[parseInt(select.value)];
                priceInput.value = service.price.toFixed(2);
                calculateTotal();
            }
        }

        function removeServiceRow(rowId) {
            const row = document.getElementById(`service-${rowId}`);
            if (row) {
                row.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            const serviceRows = document.querySelectorAll('.service-row');
            let subtotal = 0;
            
            serviceRows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.service-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.service-price').value) || 0;
                subtotal += quantity * price;
            });
            
            const igv = subtotal * 0.18;
            const total = subtotal + igv;
            
            document.getElementById('subtotalAmount').textContent = `S/. ${subtotal.toFixed(2)}`;
            document.getElementById('igvAmount').textContent = `S/. ${igv.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `S/. ${total.toFixed(2)}`;
        }

        function handleNewInvoice(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const serviceRows = document.querySelectorAll('.service-row');
            
            if (serviceRows.length === 0) {
                showNotification('Debe agregar al menos un servicio', 'error');
                return;
            }
            
            const servicios = [];
            let hasEmptyService = false;
            
            serviceRows.forEach(row => {
                const select = row.querySelector('.service-select');
                const quantity = parseFloat(row.querySelector('.service-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.service-price').value) || 0;
                
                if (select.value === '' || quantity === 0 || price === 0) {
                    hasEmptyService = true;
                    return;
                }
                
                const service = availableServices[parseInt(select.value)];
                servicios.push({
                    descripcion: service.name,
                    cantidad: quantity,
                    precio: price
                });
            });
            
            if (hasEmptyService) {
                showNotification('Complete todos los servicios o elimine las filas vacías', 'error');
                return;
            }
            
            const subtotal = servicios.reduce((sum, s) => sum + (s.cantidad * s.precio), 0);
            const igv = subtotal * 0.18;
            const total = subtotal + igv;
            
            const invoiceNumber = `F${String(invoices.length + 1).padStart(6, '0')}`;
            
            const invoiceData = {
                id: OtorongoSystem.generateId(),
                numeroFactura: invoiceNumber,
                pacienteId: formData.get('pacienteId'),
                fecha: formData.get('fecha'),
                servicios: servicios,
                subtotal: subtotal,
                igv: igv,
                total: total,
                metodoPago: formData.get('metodoPago'),
                estado: formData.get('estado'),
                observaciones: formData.get('observaciones') || '',
                fechaCreacion: new Date().toISOString(),
                creadoPor: currentUser.username
            };
            
            invoices.push(invoiceData);
            OtorongoSystem.saveInvoices(invoices);
            
            loadInvoices();
            closeModal('newInvoiceModal');
            e.target.reset();
            document.getElementById('servicesContainer').innerHTML = '';
            serviceCounter = 0;
            addServiceRow();
            calculateTotal();
            
            showNotification('Factura generada correctamente', 'success');
        }

        function displayInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            
            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice"></i>
                                <p>No hay facturas registradas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sortedInvoices = [...invoices].sort((a, b) => 
                new Date(b.fecha) - new Date(a.fecha)
            );
            
            tbody.innerHTML = sortedInvoices.map(invoice => {
                const patient = patients.find(p => p.id === invoice.pacienteId);
                const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';
                const servicesCount = invoice.servicios.length;
                
                return `
                    <tr>
                        <td><strong>${invoice.numeroFactura}</strong></td>
                        <td>${OtorongoSystem.formatDate(invoice.fecha)}</td>
                        <td>${patientName}</td>
                        <td>${servicesCount} servicio(s)</td>
                        <td><strong>S/. ${invoice.total.toFixed(2)}</strong></td>
                        <td><span class="badge ${invoice.estado}">${invoice.estado}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action" onclick="viewInvoice('${invoice.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-success" onclick="printInvoice('${invoice.id}')" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices() {
            const searchTerm = document.getElementById('searchInvoice').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = invoices;
            
            if (searchTerm) {
                filtered = filtered.filter(invoice => {
                    const patient = patients.find(p => p.id === invoice.pacienteId);
                    const patientName = patient ? `${patient.nombres} ${patient.apellidos}`.toLowerCase() : '';
                    return invoice.numeroFactura.toLowerCase().includes(searchTerm) ||
                           patientName.includes(searchTerm);
                });
            }
            
            if (statusFilter) {
                filtered = filtered.filter(invoice => invoice.estado === statusFilter);
            }
            
            // Actualizar tabla con facturas filtradas
            const tbody = document.getElementById('invoicesTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>No se encontraron facturas</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(invoice => {
                    const patient = patients.find(p => p.id === invoice.pacienteId);
                    const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';
                    const servicesCount = invoice.servicios.length;
                    
                    return `
                        <tr>
                            <td><strong>${invoice.numeroFactura}</strong></td>
                            <td>${OtorongoSystem.formatDate(invoice.fecha)}</td>
                            <td>${patientName}</td>
                            <td>${servicesCount} servicio(s)</td>
                            <td><strong>S/. ${invoice.total.toFixed(2)}</strong></td>
                            <td><span class="badge ${invoice.estado}">${invoice.estado}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action" onclick="viewInvoice('${invoice.id}')" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action btn-success" onclick="printInvoice('${invoice.id}')" title="Imprimir">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function updateStats() {
            const total = invoices.length;
            const paid = invoices.filter(inv => inv.estado === 'pagada').length;
            const pending = invoices.filter(inv => inv.estado === 'pendiente').length;
            const revenue = invoices.filter(inv => inv.estado === 'pagada')
                .reduce((sum, inv) => sum + inv.total, 0);
            
            document.getElementById('totalInvoices').textContent = total;
            document.getElementById('paidInvoices').textContent = paid;
            document.getElementById('pendingInvoices').textContent = pending;
            document.getElementById('totalRevenue').textContent = `S/. ${revenue.toFixed(2)}`;
        }

        function viewInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            selectedInvoiceId = invoiceId;
            const patient = patients.find(p => p.id === invoice.pacienteId);
            const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';
            
            const content = document.getElementById('invoiceDetailsContent');
            content.innerHTML = `
                <div class="invoice-preview">
                    <div class="invoice-header-preview">
                        <div class="company-info">
                            <h2><i class="fas fa-eye"></i> Centro Oftalmológico El Otorongo</h2>
                            <p>Faucett 326, Callao, Lima, Perú</p>
                            <p>Tel: (01) 555-0123 | Email: info@otorongo.com</p>
                        </div>
                        <div class="invoice-info">
                            <h3>FACTURA</h3>
                            <p><strong>${invoice.numeroFactura}</strong></p>
                            <p>Fecha: ${OtorongoSystem.formatDate(invoice.fecha)}</p>
                        </div>
                    </div>
                    
                    <div class="patient-info-section">
                        <h4>Datos del Paciente</h4>
                        <div class="info-grid">
                            <div><strong>Nombre:</strong> ${patientName}</div>
                            <div><strong>DNI:</strong> ${patient ? patient.dni : 'N/A'}</div>
                            <div><strong>Teléfono:</strong> ${patient ? patient.telefono : 'N/A'}</div>
                            <div><strong>Seguro:</strong> ${patient ? patient.seguro : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="services-table">
                        <h4>Servicios</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.servicios.map(s => `
                                    <tr>
                                        <td>${s.descripcion}</td>
                                        <td>${s.cantidad}</td>
                                        <td>S/. ${s.precio.toFixed(2)}</td>
                                        <td>S/. ${(s.cantidad * s.precio).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="invoice-totals">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>S/. ${invoice.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="total-row">
                            <span>IGV (18%):</span>
                            <span>S/. ${invoice.igv.toFixed(2)}</span>
                        </div>
                        <div class="total-row final">
                            <span>Total:</span>
                            <span>S/. ${invoice.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="payment-info">
                        <div><strong>Método de Pago:</strong> ${invoice.metodoPago}</div>
                        <div><strong>Estado:</strong> <span class="badge ${invoice.estado}">${invoice.estado}</span></div>
                        ${invoice.observaciones ? `<div><strong>Observaciones:</strong> ${invoice.observaciones}</div>` : ''}
                    </div>
                </div>
            `;
            
            openModal('viewInvoiceModal');
        }

        function printInvoice(invoiceId) {
            if (invoiceId) {
                selectedInvoiceId = invoiceId;
            }
            
            if (!selectedInvoiceId) return;
            
            const invoice = invoices.find(inv => inv.id === selectedInvoiceId);
            if (!invoice) return;
            
            const patient = patients.find(p => p.id === invoice.pacienteId);
            const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura ${invoice.numeroFactura}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2c5aa0; padding-bottom: 20px; }
                        .header h1 { color: #2c5aa0; margin: 0; }
                        .info-section { margin: 20px 0; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #2c5aa0; color: white; }
                        .totals { text-align: right; margin: 20px 0; }
                        .totals div { margin: 5px 0; }
                        .final-total { font-size: 1.2em; font-weight: bold; color: #2c5aa0; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Centro Oftalmológico El Otorongo</h1>
                        <p>Faucett 326, Callao, Lima, Perú</p>
                        <p>Tel: (01) 555-0123 | Email: info@otorongo.com</p>
                    </div>
                    
                    <div class="info-section">
                        <h2>FACTURA ${invoice.numeroFactura}</h2>
                        <p><strong>Fecha:</strong> ${OtorongoSystem.formatDate(invoice.fecha)}</p>
                    </div>
                    
                    <div class="info-section">
                        <h3>Datos del Paciente</h3>
                        <div class="info-grid">
                            <div><strong>Nombre:</strong> ${patientName}</div>
                            <div><strong>DNI:</strong> ${patient ? patient.dni : 'N/A'}</div>
                            <div><strong>Teléfono:</strong> ${patient ? patient.telefono : 'N/A'}</div>
                            <div><strong>Seguro:</strong> ${patient ? patient.seguro : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.servicios.map(s => `
                                <tr>
                                    <td>${s.descripcion}</td>
                                    <td>${s.cantidad}</td>
                                    <td>S/. ${s.precio.toFixed(2)}</td>
                                    <td>S/. ${(s.cantidad * s.precio).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="totals">
                        <div>Subtotal: S/. ${invoice.subtotal.toFixed(2)}</div>
                        <div>IGV (18%): S/. ${invoice.igv.toFixed(2)}</div>
                        <div class="final-total">Total: S/. ${invoice.total.toFixed(2)}</div>
                    </div>
                    
                    <div class="info-section">
                        <p><strong>Método de Pago:</strong> ${invoice.metodoPago}</p>
                        <p><strong>Estado:</strong> ${invoice.estado}</p>
                        ${invoice.observaciones ? `<p><strong>Observaciones:</strong> ${invoice.observaciones}</p>` : ''}
                    </div>
                    
                    <button onclick="window.print()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; cursor: pointer; margin-top: 20px;">Imprimir</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function downloadInvoicePDF() {
            showNotification('Generando PDF...', 'info');
            setTimeout(() => {
                showNotification('Función de descarga PDF en desarrollo. Use la opción de imprimir y guardar como PDF.', 'info');
            }, 1000);
        }

        function sendInvoiceEmail() {
            showNotification('Función de envío por email en desarrollo', 'info');
        }

        function exportInvoices() {
            if (invoices.length === 0) {
                showNotification('No hay facturas para exportar', 'warning');
                return;
            }
            
            let csv = 'Número,Fecha,Paciente,DNI,Total,Estado,Método de Pago\n';
            
            invoices.forEach(invoice => {
                const patient = patients.find(p => p.id === invoice.pacienteId);
                const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'N/A';
                const dni = patient ? patient.dni : 'N/A';
                
                csv += `${invoice.numeroFactura},${invoice.fecha},"${patientName}",${dni},${invoice.total.toFixed(2)},${invoice.estado},${invoice.metodoPago}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facturas_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Facturas exportadas correctamente', 'success');
        }

        function showNotifications() {
            const pending = invoices.filter(inv => inv.estado === 'pendiente').length;
            if (pending > 0) {
                showNotification(`Tiene ${pending} factura(s) pendiente(s) de pago`, 'warning');
            } else {
                showNotification('No hay facturas pendientes', 'success');
            }
        }

        function showProfile() {
            showNotification('Función de perfil en desarrollo', 'info');
        }

        function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                localStorage.removeItem('otorongo_current_user');
                localStorage.removeItem('otorongo_login_time');
                showNotification('Sesión cerrada correctamente', 'success');
                setTimeout(() => window.location.href = 'login.html', 1500);
            }
        }
    </script>

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .page-title h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-title p {
            color: var(--gray-600);
        }

        .page-actions {
            display: flex;
            gap: 1rem;
        }

        .invoices-section {
            margin-top: 2rem;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
        }

        .filter-controls input,
        .filter-controls select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            background: var(--white);
        }

        .filter-controls input {
            min-width: 250px;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-action:hover {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .btn-action.btn-success:hover {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .patient-info-card {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .services-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h4 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .service-row {
            margin-bottom: 1rem;
        }

        .service-inputs {
            display: grid;
            grid-template-columns: 2fr 100px 120px 50px;
            gap: 0.75rem;
            align-items: center;
        }

        .service-select,
        .service-quantity,
        .service-price {
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            background: var(--white);
        }

        .btn-remove {
            background: var(--danger-color);
            color: var(--white);
            border: none;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-remove:hover {
            background: #c82333;
        }

        .invoice-summary {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--primary-color);
            margin: 2rem 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 1.1rem;
        }

        .summary-row.total {
            border-top: 2px solid var(--gray-300);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .invoice-preview {
            background: var(--white);
            padding: 2rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
        }

        .invoice-header-preview {
            display: flex;
            justify-content: space-between;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 2rem;
        }

        .company-info h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .company-info p {
            color: var(--gray-600);
            margin: 0.25rem 0;
        }

        .invoice-info {
            text-align: right;
        }

        .invoice-info h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .patient-info-section,
        .services-table,
        .payment-info {
            margin: 2rem 0;
        }

        .patient-info-section h4,
        .services-table h4 {
            color: var(--dark-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .invoice-totals {
            text-align: right;
            margin: 2rem 0;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .total-row {
            display: flex;
            justify-content: flex-end;
            gap: 2rem;
            padding: 0.5rem 0;
            font-size: 1.1rem;
        }

        .total-row.final {
            border-top: 2px solid var(--gray-300);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .payment-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .payment-info div {
            margin: 0.5rem 0;
        }

        .badge.pagada {
            background: var(--success-color);
            color: var(--white);
        }

        .badge.pendiente {
            background: var(--warning-color);
            color: var(--gray-800);
        }

        .badge.cancelada {
            background: var(--danger-color);
            color: var(--white);
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .service-inputs {
                grid-template-columns: 1fr;
            }

            .patient-info-grid,
            .info-grid {
                grid-template-columns: 1fr;
            }

            .invoice-header-preview {
                flex-direction: column;
                gap: 1rem;
            }

            .invoice-info {
                text-align: left;
            }
        }
    </style>
</body>
</html>
