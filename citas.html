<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Citas - Centro Oftalmológico El Otorongo</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="dashboard-page">
    <!-- Header del Dashboard -->
    <header class="dashboard-header-main">
        <div class="container">
            <div class="dashboard-brand">
                <i class="fas fa-eye"></i>
                <h1>Centro Oftalmológico El Otorongo</h1>
            </div>
            
            <div class="dashboard-user-info">
                <div class="user-welcome">
                    <span class="user-greeting">Bienvenido,</span>
                    <span class="user-name" id="userName">Usuario</span>
                    <span class="user-role" id="userRole">Rol</span>
                </div>
                <div class="user-actions">
                    <button class="btn-notification" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">3</span>
                    </button>
                    <button class="btn-profile" onclick="showProfile()">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegación Principal -->
    <nav class="dashboard-nav">
        <div class="container">
            <ul class="nav-menu" id="dashboardMenu">
                <!-- El menú se carga dinámicamente según el rol -->
            </ul>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="dashboard-main">
        <div class="container">
            <!-- Header de la página -->
            <div class="page-header">
                <div class="page-title">
                    <h2><i class="fas fa-calendar-alt"></i> Gestión de Citas</h2>
                    <p>Administre las citas médicas del centro oftalmológico</p>
                </div>
                <div class="page-actions">
                    <button class="btn-primary" onclick="openModal('newAppointmentModal')">
                        <i class="fas fa-plus"></i> Nueva Cita
                    </button>
                    <button class="btn-secondary" onclick="refreshAppointments()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Filtros y búsqueda -->
            <div class="filters-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
                    </div>
                    <div class="filters-content">
                        <div class="filter-group">
                            <label for="searchAppointment">Buscar:</label>
                            <input type="text" id="searchAppointment" placeholder="Buscar por paciente, médico o tipo de cita">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterDate">Fecha:</label>
                            <input type="date" id="filterDate">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterDoctor">Médico:</label>
                            <select id="filterDoctor">
                                <option value="">Todos los médicos</option>
                                <option value="Dr. Carlos Mendoza">Dr. Carlos Mendoza</option>
                                <option value="Dra. Ana García">Dra. Ana García</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterStatus">Estado:</label>
                            <select id="filterStatus">
                                <option value="">Todos los estados</option>
                                <option value="programada">Programada</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                                <option value="no-asistio">No asistió</option>
                            </select>
                        </div>
                        
                        <div class="filter-actions">
                            <button class="btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            <button class="btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista de calendario -->
            <div class="calendar-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar"></i> Calendario de Citas</h3>
                        <div class="calendar-controls">
                            <button class="btn-calendar-nav" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="calendar-month" id="currentMonth">Enero 2025</span>
                            <button class="btn-calendar-nav" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar" id="appointmentCalendar">
                            <!-- El calendario se genera dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de citas -->
            <div class="appointments-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Lista de Citas</h3>
                        <div class="list-controls">
                            <select id="appointmentsPerPage" onchange="changeAppointmentsPerPage()">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="appointmentsTable">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Paciente</th>
                                    <th>Médico</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsTableBody">
                                <!-- Las citas se cargan dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="appointmentsPagination">
                        <!-- La paginación se genera dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Nueva Cita -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-calendar-plus"></i> Nueva Cita
                </h3>
                <button class="modal-close" onclick="closeModal('newAppointmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="appointmentPatient">
                                <i class="fas fa-user"></i> Paciente *
                            </label>
                            <select id="appointmentPatient" name="pacienteId" required>
                                <option value="">Seleccione un paciente</option>
                                <!-- Los pacientes se cargan dinámicamente -->
                            </select>
                            <button type="button" class="btn-link" onclick="openModal('newPatientModal')">
                                <i class="fas fa-plus"></i> Registrar nuevo paciente
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="appointmentDoctor">
                                <i class="fas fa-user-md"></i> Médico *
                            </label>
                            <select id="appointmentDoctor" name="medico" required>
                                <option value="">Seleccione un médico</option>
                                <option value="Dr. Carlos Mendoza">Dr. Carlos Mendoza</option>
                                <option value="Dra. Ana García">Dra. Ana García</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="appointmentDate">
                                <i class="fas fa-calendar"></i> Fecha *
                            </label>
                            <input type="date" id="appointmentDate" name="fecha" required>
                        </div>

                        <div class="form-group">
                            <label for="appointmentTime">
                                <i class="fas fa-clock"></i> Hora *
                            </label>
                            <select id="appointmentTime" name="hora" required>
                                <option value="">Seleccione una hora</option>
                                <!-- Las horas disponibles se cargan dinámicamente -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="appointmentType">
                                <i class="fas fa-stethoscope"></i> Tipo de Consulta *
                            </label>
                            <select id="appointmentType" name="tipo" required>
                                <option value="">Seleccione el tipo</option>
                                <option value="Consulta General">Consulta General</option>
                                <option value="Control">Control</option>
                                <option value="Cirugía">Cirugía</option>
                                <option value="Emergencia">Emergencia</option>
                                <option value="Examen Especializado">Examen Especializado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="appointmentDuration">
                                <i class="fas fa-hourglass-half"></i> Duración (minutos)
                            </label>
                            <select id="appointmentDuration" name="duracion">
                                <option value="30">30 minutos</option>
                                <option value="45">45 minutos</option>
                                <option value="60">60 minutos</option>
                                <option value="90">90 minutos</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="appointmentNotes">
                                <i class="fas fa-notes-medical"></i> Observaciones
                            </label>
                            <textarea id="appointmentNotes" name="observaciones" rows="3" 
                                placeholder="Observaciones adicionales sobre la cita"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Programar Cita
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('newAppointmentModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Cita -->
    <div id="editAppointmentModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i> Editar Cita
                </h3>
                <button class="modal-close" onclick="closeModal('editAppointmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAppointmentForm">
                    <input type="hidden" id="editAppointmentId" name="id">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="editAppointmentPatient">
                                <i class="fas fa-user"></i> Paciente *
                            </label>
                            <select id="editAppointmentPatient" name="pacienteId" required>
                                <!-- Los pacientes se cargan dinámicamente -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editAppointmentDoctor">
                                <i class="fas fa-user-md"></i> Médico *
                            </label>
                            <select id="editAppointmentDoctor" name="medico" required>
                                <option value="Dr. Carlos Mendoza">Dr. Carlos Mendoza</option>
                                <option value="Dra. Ana García">Dra. Ana García</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editAppointmentDate">
                                <i class="fas fa-calendar"></i> Fecha *
                            </label>
                            <input type="date" id="editAppointmentDate" name="fecha" required>
                        </div>

                        <div class="form-group">
                            <label for="editAppointmentTime">
                                <i class="fas fa-clock"></i> Hora *
                            </label>
                            <select id="editAppointmentTime" name="hora" required>
                                <!-- Las horas disponibles se cargan dinámicamente -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editAppointmentType">
                                <i class="fas fa-stethoscope"></i> Tipo de Consulta *
                            </label>
                            <select id="editAppointmentType" name="tipo" required>
                                <option value="Consulta General">Consulta General</option>
                                <option value="Control">Control</option>
                                <option value="Cirugía">Cirugía</option>
                                <option value="Emergencia">Emergencia</option>
                                <option value="Examen Especializado">Examen Especializado</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editAppointmentStatus">
                                <i class="fas fa-info-circle"></i> Estado
                            </label>
                            <select id="editAppointmentStatus" name="estado">
                                <option value="programada">Programada</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                                <option value="no-asistio">No asistió</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="editAppointmentNotes">
                                <i class="fas fa-notes-medical"></i> Observaciones
                            </label>
                            <textarea id="editAppointmentNotes" name="observaciones" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('editAppointmentModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles de Cita -->
    <div id="viewAppointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-eye"></i> Detalles de la Cita
                </h3>
                <button class="modal-close" onclick="closeModal('viewAppointmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="appointment-details-grid" id="appointmentDetailsContent">
                    <!-- Los detalles se cargan dinámicamente -->
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="editAppointmentFromView()">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-danger" onclick="cancelAppointmentFromView()">
                        <i class="fas fa-ban"></i> Cancelar Cita
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Variables globales para citas
        let currentUser = null;
        let appointments = [];
        let filteredAppointments = [];
        let currentPage = 1;
        let appointmentsPerPage = 10;
        let currentDate = new Date();
        let selectedAppointmentId = null;

        // Inicializar página de citas
        document.addEventListener('DOMContentLoaded', function() {
            initializeAppointmentsPage();
        });

        // Inicializar página
        function initializeAppointmentsPage() {
            // Verificar autenticación
            if (!checkAuthentication()) {
                return;
            }

            // Cargar datos del usuario
            loadUserData();
            
            // Configurar menú según rol
            setupRoleBasedMenu();
            
            // Cargar datos iniciales
            loadAppointments();
            loadPatients();
            
            // Configurar formularios
            setupAppointmentForms();
            
            // Configurar filtros
            setupFilters();
            
            // Generar calendario
            generateCalendar();
            
            // Configurar fecha mínima para citas
            setupDateConstraints();
        }

        // Verificar autenticación
        function checkAuthentication() {
            const savedUser = localStorage.getItem('otorongo_current_user');
            
            if (!savedUser) {
                showNotification('Sesión expirada. Redirigiendo al login...', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            
            currentUser = JSON.parse(savedUser);
            return true;
        }

        // Cargar datos del usuario
        function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
        }

        // Obtener nombre de rol para mostrar
        function getRoleDisplayName(role) {
            const roleNames = {
                'administrador': 'Administrador',
                'medico': 'Médico',
                'recepcionista': 'Recepcionista'
            };
            return roleNames[role] || role;
        }

        // Configurar menú según rol
        function setupRoleBasedMenu() {
            const menuContainer = document.getElementById('dashboardMenu');
            const menus = {
                'administrador': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas', active: true },
                    { icon: 'fas fa-file-invoice-dollar', text: 'Facturación', page: 'facturacion' },
                    { icon: 'fas fa-chart-bar', text: 'Reportes', page: 'reportes' }
                ],
                'medico': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Mis Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Mis Citas', page: 'citas', active: true },
                    { icon: 'fas fa-notes-medical', text: 'Historiales', page: 'historiales' }
                ],
                'recepcionista': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes' },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas', active: true },
                    { icon: 'fas fa-file-invoice', text: 'Facturación', page: 'facturacion' }
                ]
            };

            const userMenu = menus[currentUser.role] || menus['recepcionista'];
            
            menuContainer.innerHTML = userMenu.map(item => `
                <li>
                    <a href="${item.page}.html" class="nav-item ${item.active ? 'active' : ''}">
                        <i class="${item.icon}"></i>
                        <span>${item.text}</span>
                    </a>
                </li>
            `).join('');
        }

        // Cargar citas
        function loadAppointments() {
            appointments = OtorongoSystem.getAppointments();
            
            // Filtrar por médico si es necesario
            if (currentUser.role === 'medico') {
                appointments = appointments.filter(apt => apt.medico === currentUser.name);
            }
            
            filteredAppointments = [...appointments];
            displayAppointments();
            updateCalendar();
        }

        // Cargar pacientes para los selects
        function loadPatients() {
            const patients = OtorongoSystem.getPatients();
            const patientSelects = ['appointmentPatient', 'editAppointmentPatient'];
            
            patientSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Seleccione un paciente</option>';
                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.id;
                        option.textContent = `${patient.nombres} ${patient.apellidos} - DNI: ${patient.dni}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Configurar formularios
        function setupAppointmentForms() {
            // Formulario nueva cita
            const newForm = document.getElementById('newAppointmentForm');
            if (newForm) {
                newForm.addEventListener('submit', handleNewAppointment);
            }

            // Formulario editar cita
            const editForm = document.getElementById('editAppointmentForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditAppointment);
            }

            // Configurar cambios de fecha para actualizar horas disponibles
            const dateInputs = ['appointmentDate', 'editAppointmentDate'];
            dateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', function() {
                        updateAvailableHours(this.value, inputId.replace('Date', 'Time'));
                    });
                }
            });
        }

        // Configurar restricciones de fecha
        function setupDateConstraints() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['appointmentDate', 'editAppointmentDate', 'filterDate'];
            
            dateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && inputId !== 'filterDate') {
                    input.min = today;
                }
            });
        }

        // Actualizar horas disponibles
        function updateAvailableHours(date, timeSelectId) {
            const timeSelect = document.getElementById(timeSelectId);
            if (!timeSelect || !date) return;

            // Generar horas de trabajo (8:00 AM - 6:00 PM)
            const workingHours = [];
            for (let hour = 8; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    workingHours.push(timeString);
                }
            }

            // Filtrar horas ocupadas
            const occupiedHours = appointments
                .filter(apt => apt.fecha === date && apt.estado !== 'cancelada')
                .map(apt => apt.hora);

            timeSelect.innerHTML = '<option value="">Seleccione una hora</option>';
            
            workingHours.forEach(hour => {
                if (!occupiedHours.includes(hour)) {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = OtorongoSystem.formatTime(hour);
                    timeSelect.appendChild(option);
                }
            });
        }

        // Configurar filtros
        function setupFilters() {
            const searchInput = document.getElementById('searchAppointment');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }

            const filterInputs = ['filterDate', 'filterDoctor', 'filterStatus'];
            filterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', applyFilters);
                }
            });
        }

        // Función debounce para búsqueda
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('searchAppointment').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            const filterDoctor = document.getElementById('filterDoctor').value;
            const filterStatus = document.getElementById('filterStatus').value;

            filteredAppointments = appointments.filter(appointment => {
                const patient = OtorongoSystem.getPatientById(appointment.pacienteId);
                const patientName = patient ? `${patient.nombres} ${patient.apellidos}`.toLowerCase() : '';
                
                const matchesSearch = !searchTerm || 
                    patientName.includes(searchTerm) ||
                    appointment.medico.toLowerCase().includes(searchTerm) ||
                    appointment.tipo.toLowerCase().includes(searchTerm);
                
                const matchesDate = !filterDate || appointment.fecha === filterDate;
                const matchesDoctor = !filterDoctor || appointment.medico === filterDoctor;
                const matchesStatus = !filterStatus || appointment.estado === filterStatus;

                return matchesSearch && matchesDate && matchesDoctor && matchesStatus;
            });

            currentPage = 1;
            displayAppointments();
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('searchAppointment').value = '';
            document.getElementById('filterDate').value = '';
            document.getElementById('filterDoctor').value = '';
            document.getElementById('filterStatus').value = '';
            
            filteredAppointments = [...appointments];
            currentPage = 1;
            displayAppointments();
        }

        // Mostrar citas en la tabla
        function displayAppointments() {
            const tbody = document.getElementById('appointmentsTableBody');
            const startIndex = (currentPage - 1) * appointmentsPerPage;
            const endIndex = startIndex + appointmentsPerPage;
            const pageAppointments = filteredAppointments.slice(startIndex, endIndex);

            if (pageAppointments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-calendar-times"></i>
                                <p>No se encontraron citas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageAppointments.map(appointment => {
                const patient = OtorongoSystem.getPatientById(appointment.pacienteId);
                const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';
                
                return `
                    <tr>
                        <td>${OtorongoSystem.formatDate(appointment.fecha)}</td>
                        <td>${OtorongoSystem.formatTime(appointment.hora)}</td>
                        <td>${patientName}</td>
                        <td>${appointment.medico}</td>
                        <td>${appointment.tipo}</td>
                        <td><span class="badge ${appointment.estado}">${appointment.estado}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action" onclick="viewAppointment('${appointment.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action" onclick="editAppointment('${appointment.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-danger" onclick="cancelAppointment('${appointment.id}')" title="Cancelar">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            generatePagination();
        }

        // Generar paginación
        function generatePagination() {
            const totalPages = Math.ceil(filteredAppointments.length / appointmentsPerPage);
            const paginationContainer = document.getElementById('appointmentsPagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="pagination-controls">';
            
            // Botón anterior
            if (currentPage > 1) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>`;
            }

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="btn-pagination active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="btn-pagination" onclick="changePage(${i})">${i}</button>`;
                }
            }

            // Botón siguiente
            if (currentPage < totalPages) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            paginationHTML += '</div>';
            paginationContainer.innerHTML = paginationHTML;
        }

        // Cambiar página
        function changePage(page) {
            currentPage = page;
            displayAppointments();
        }

        // Cambiar citas por página
        function changeAppointmentsPerPage() {
            appointmentsPerPage = parseInt(document.getElementById('appointmentsPerPage').value);
            currentPage = 1;
            displayAppointments();
        }

        // Generar calendario
        function generateCalendar() {
            const calendar = document.getElementById('appointmentCalendar');
            const monthNames = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let calendarHTML = `
                <div class="calendar-header">
                    <div class="calendar-day-header">Dom</div>
                    <div class="calendar-day-header">Lun</div>
                    <div class="calendar-day-header">Mar</div>
                    <div class="calendar-day-header">Mié</div>
                    <div class="calendar-day-header">Jue</div>
                    <div class="calendar-day-header">Vie</div>
                    <div class="calendar-day-header">Sáb</div>
                </div>
                <div class="calendar-body">
            `;
            
            const currentDateObj = new Date(startDate);
            
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<div class="calendar-week">';
                
                for (let day = 0; day < 7; day++) {
                    const dateStr = currentDateObj.toISOString().split('T')[0];
                    const dayAppointments = appointments.filter(apt => apt.fecha === dateStr);
                    const isCurrentMonth = currentDateObj.getMonth() === month;
                    const isToday = dateStr === new Date().toISOString().split('T')[0];
                    
                    let dayClass = 'calendar-day';
                    if (!isCurrentMonth) dayClass += ' other-month';
                    if (isToday) dayClass += ' today';
                    if (dayAppointments.length > 0) dayClass += ' has-appointments';
                    
                    calendarHTML += `
                        <div class="${dayClass}" data-date="${dateStr}" onclick="selectCalendarDate('${dateStr}')">
                            <div class="day-number">${currentDateObj.getDate()}</div>
                            ${dayAppointments.length > 0 ? `<div class="appointment-count">${dayAppointments.length}</div>` : ''}
                        </div>
                    `;
                    
                    currentDateObj.setDate(currentDateObj.getDate() + 1);
                }
                
                calendarHTML += '</div>';
            }
            
            calendarHTML += '</div>';
            calendar.innerHTML = calendarHTML;
        }

        // Navegar mes anterior
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        // Navegar mes siguiente
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Seleccionar fecha en calendario
        function selectCalendarDate(date) {
            document.getElementById('filterDate').value = date;
            applyFilters();
        }

        // Actualizar calendario
        function updateCalendar() {
            generateCalendar();
        }

        // Manejar nueva cita
        function handleNewAppointment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const appointmentData = {
                id: OtorongoSystem.generateId(),
                pacienteId: formData.get('pacienteId'),
                medico: formData.get('medico'),
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                tipo: formData.get('tipo'),
                estado: 'programada',
                observaciones: formData.get('observaciones') || '',
                fechaCreacion: new Date().toISOString()
            };

            // Validar que no haya conflictos de horario
            const conflict = appointments.find(apt => 
                apt.fecha === appointmentData.fecha &&
                apt.hora === appointmentData.hora &&
                apt.medico === appointmentData.medico &&
                apt.estado !== 'cancelada'
            );

            if (conflict) {
                showNotification('Ya existe una cita programada para esa fecha y hora con el mismo médico', 'error');
                return;
            }

            // Guardar cita
            appointments.push(appointmentData);
            OtorongoSystem.saveAppointments(appointments);
            
            // Actualizar vista
            loadAppointments();
            closeModal('newAppointmentModal');
            e.target.reset();
            
            showNotification('Cita programada correctamente', 'success');
        }

        // Ver detalles de cita
        function viewAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;

            const patient = OtorongoSystem.getPatientById(appointment.pacienteId);
            const patientName = patient ? `${patient.nombres} ${patient.apellidos}` : 'Paciente no encontrado';

            selectedAppointmentId = appointmentId;

            const detailsContainer = document.getElementById('appointmentDetailsContent');
            detailsContainer.innerHTML = `
                <div class="detail-item">
                    <label><i class="fas fa-user"></i> Paciente:</label>
                    <span>${patientName}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-id-card"></i> DNI:</label>
                    <span>${patient ? patient.dni : 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-user-md"></i> Médico:</label>
                    <span>${appointment.medico}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-calendar"></i> Fecha:</label>
                    <span>${OtorongoSystem.formatDate(appointment.fecha)}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-clock"></i> Hora:</label>
                    <span>${OtorongoSystem.formatTime(appointment.hora)}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-stethoscope"></i> Tipo:</label>
                    <span>${appointment.tipo}</span>
                </div>
                <div class="detail-item">
                    <label><i class="fas fa-info-circle"></i> Estado:</label>
                    <span class="badge ${appointment.estado}">${appointment.estado}</span>
                </div>
                ${appointment.observaciones ? `
                    <div class="detail-item full-width">
                        <label><i class="fas fa-notes-medical"></i> Observaciones:</label>
                        <span>${appointment.observaciones}</span>
                    </div>
                ` : ''}
            `;

            openModal('viewAppointmentModal');
        }

        // Editar cita
        function editAppointment(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;

            selectedAppointmentId = appointmentId;

            // Llenar formulario de edición
            document.getElementById('editAppointmentId').value = appointment.id;
            document.getElementById('editAppointmentPatient').value = appointment.pacienteId;
            document.getElementById('editAppointmentDoctor').value = appointment.medico;
            document.getElementById('editAppointmentDate').value = appointment.fecha;
            document.getElementById('editAppointmentType').value = appointment.tipo;
            document.getElementById('editAppointmentStatus').value = appointment.estado;
            document.getElementById('editAppointmentNotes').value = appointment.observaciones;

            // Actualizar horas disponibles
            updateAvailableHours(appointment.fecha, 'editAppointmentTime');
            setTimeout(() => {
                document.getElementById('editAppointmentTime').value = appointment.hora;
            }, 100);

            openModal('editAppointmentModal');
        }

        // Manejar edición de cita
        function handleEditAppointment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const appointmentId = formData.get('id');
            
            const updatedData = {
                pacienteId: formData.get('pacienteId'),
                medico: formData.get('medico'),
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                tipo: formData.get('tipo'),
                estado: formData.get('estado'),
                observaciones: formData.get('observaciones') || ''
            };

            // Validar conflictos (excluyendo la cita actual)
            const conflict = appointments.find(apt => 
                apt.id !== appointmentId &&
                apt.fecha === updatedData.fecha &&
                apt.hora === updatedData.hora &&
                apt.medico === updatedData.medico &&
                apt.estado !== 'cancelada'
            );

            if (conflict) {
                showNotification('Ya existe una cita programada para esa fecha y hora con el mismo médico', 'error');
                return;
            }

            // Actualizar cita
            const appointmentIndex = appointments.findIndex(apt => apt.id === appointmentId);
            if (appointmentIndex !== -1) {
                appointments[appointmentIndex] = { ...appointments[appointmentIndex], ...updatedData };
                OtorongoSystem.saveAppointments(appointments);
                
                loadAppointments();
                closeModal('editAppointmentModal');
                
                showNotification('Cita actualizada correctamente', 'success');
            }
        }

        // Cancelar cita
        function cancelAppointment(appointmentId) {
            if (!confirm('¿Está seguro que desea cancelar esta cita?')) {
                return;
            }

            const appointmentIndex = appointments.findIndex(apt => apt.id === appointmentId);
            if (appointmentIndex !== -1) {
                appointments[appointmentIndex].estado = 'cancelada';
                OtorongoSystem.saveAppointments(appointments);
                
                loadAppointments();
                showNotification('Cita cancelada correctamente', 'success');
            }
        }

        // Editar desde vista de detalles
        function editAppointmentFromView() {
            closeModal('viewAppointmentModal');
            editAppointment(selectedAppointmentId);
        }

        // Cancelar desde vista de detalles
        function cancelAppointmentFromView() {
            closeModal('viewAppointmentModal');
            cancelAppointment(selectedAppointmentId);
        }

        // Actualizar citas
        function refreshAppointments() {
            loadAppointments();
            showNotification('Citas actualizadas', 'success');
        }

        // Funciones de navegación y utilidad
        function showNotifications() {
            // Implementar notificaciones
            showNotification('Función de notificaciones en desarrollo', 'info');
        }

        function showProfile() {
            // Implementar perfil
            showNotification('Función de perfil en desarrollo', 'info');
        }

        function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                localStorage.removeItem('otorongo_current_user');
                localStorage.removeItem('otorongo_login_time');
                showNotification('Sesión cerrada correctamente', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        }
    </script>

    <style>
        /* Estilos específicos para la página de citas */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .page-title h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-title p {
            color: var(--gray-600);
            margin: 0;
        }

        .page-actions {
            display: flex;
            gap: 1rem;
        }

        .filters-section {
            margin-bottom: 2rem;
        }

        .filters-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-section {
            margin-bottom: 2rem;
        }

        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-calendar-nav {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-calendar-nav:hover {
            background: #1e3d6f;
        }

        .calendar-month {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
            min-width: 150px;
            text-align: center;
        }

        .calendar-container {
            padding: 1rem;
        }

        .calendar {
            width: 100%;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }

        .calendar-day-header {
            background: var(--primary-color);
            color: var(--white);
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-body {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            gap: 1px;
        }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: 0.5rem;
            min-height: 80px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: var(--gray-50);
        }

        .calendar-day.other-month {
            background: var(--gray-100);
            color: var(--gray-400);
        }

        .calendar-day.today {
            background: var(--accent-color);
            color: var(--white);
        }

        .calendar-day.has-appointments {
            background: var(--success-color);
            color: var(--white);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .appointment-count {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: auto;
            align-self: flex-end;
        }

        .appointments-section {
            margin-bottom: 2rem;
        }

        .list-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn-action.btn-danger {
            color: var(--danger-color);
        }

        .btn-action.btn-danger:hover {
            background: var(--danger-color);
            color: var(--white);
        }

        .pagination {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
        }

        .pagination-controls {
            display: flex;
            gap: 0.25rem;
        }

        .btn-pagination {
            background: var(--white);
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-pagination:hover {
            background: var(--gray-100);
        }

        .btn-pagination.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .modal-content.large {
            max-width: 800px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-top: 0.25rem;
        }

        .btn-link:hover {
            color: #1e3d6f;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .appointment-details-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .detail-item.full-width {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .detail-item label {
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .page-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .filters-content {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 60px;
                padding: 0.25rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .page-title h2 {
                font-size: 1.5rem;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .calendar-day {
                min-height: 50px;
            }

            .form-actions {
                flex-direction: column;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>
