<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes - Centro Oftalmológico El Otorongo</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="dashboard-page">
    <!-- Header del Dashboard -->
    <header class="dashboard-header-main">
        <div class="container">
            <div class="dashboard-brand">
                <i class="fas fa-eye"></i>
                <h1>Centro Oftalmológico El Otorongo</h1>
            </div>
            
            <div class="dashboard-user-info">
                <div class="user-welcome">
                    <span class="user-greeting">Bienvenido,</span>
                    <span class="user-name" id="userName">Usuario</span>
                    <span class="user-role" id="userRole">Rol</span>
                </div>
                <div class="user-actions">
                    <button class="btn-notification" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">3</span>
                    </button>
                    <button class="btn-profile" onclick="showProfile()">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="btn-logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navegación Principal -->
    <nav class="dashboard-nav">
        <div class="container">
            <ul class="nav-menu" id="dashboardMenu">
                <!-- El menú se carga dinámicamente según el rol -->
            </ul>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="dashboard-main">
        <div class="container">
            <!-- Header de la página -->
            <div class="page-header">
                <div class="page-title">
                    <h2><i class="fas fa-users"></i> Gestión de Pacientes</h2>
                    <p>Administre los registros médicos y datos de los pacientes</p>
                </div>
                <div class="page-actions">
                    <button class="btn-primary" onclick="openModal('newPatientModal')">
                        <i class="fas fa-user-plus"></i> Nuevo Paciente
                    </button>
                    <button class="btn-secondary" onclick="refreshPatients()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- Lista de pacientes -->
            <div class="patients-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Lista de Pacientes</h3>
                        <div class="list-controls">
                            <input type="text" id="searchPatient" placeholder="Buscar pacientes..." style="margin-right: 1rem;">
                            <select id="patientsPerPage" onchange="changePatientsPerPage()">
                                <option value="10">10 por página</option>
                                <option value="25">25 por página</option>
                                <option value="50">50 por página</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table" id="patientsTable">
                            <thead>
                                <tr>
                                    <th>DNI</th>
                                    <th>Nombre Completo</th>
                                    <th>Edad</th>
                                    <th>Teléfono</th>
                                    <th>Seguro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="patientsTableBody">
                                <!-- Los pacientes se cargan dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="patientsPagination">
                        <!-- La paginación se genera dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Nuevo Paciente -->
    <div id="newPatientModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i> Nuevo Paciente
                </h3>
                <button class="modal-close" onclick="closeModal('newPatientModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="newPatientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="patientDni">
                                <i class="fas fa-id-card"></i> DNI *
                            </label>
                            <input type="text" id="patientDni" name="dni" required maxlength="8" pattern="[0-9]{8}">
                        </div>

                        <div class="form-group">
                            <label for="patientNames">
                                <i class="fas fa-user"></i> Nombres *
                            </label>
                            <input type="text" id="patientNames" name="nombres" required>
                        </div>

                        <div class="form-group">
                            <label for="patientLastNames">
                                <i class="fas fa-user"></i> Apellidos *
                            </label>
                            <input type="text" id="patientLastNames" name="apellidos" required>
                        </div>

                        <div class="form-group">
                            <label for="patientBirthDate">
                                <i class="fas fa-calendar"></i> Fecha de Nacimiento *
                            </label>
                            <input type="date" id="patientBirthDate" name="fechaNacimiento" required>
                        </div>

                        <div class="form-group">
                            <label for="patientPhone">
                                <i class="fas fa-phone"></i> Teléfono *
                            </label>
                            <input type="tel" id="patientPhone" name="telefono" required>
                        </div>

                        <div class="form-group">
                            <label for="patientEmail">
                                <i class="fas fa-envelope"></i> Email
                            </label>
                            <input type="email" id="patientEmail" name="email">
                        </div>

                        <div class="form-group">
                            <label for="patientInsurance">
                                <i class="fas fa-shield-alt"></i> Seguro Médico *
                            </label>
                            <select id="patientInsurance" name="seguro" required>
                                <option value="">Seleccione</option>
                                <option value="SIS">SIS</option>
                                <option value="EsSalud">EsSalud</option>
                                <option value="Privado">Privado</option>
                                <option value="Particular">Particular</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label for="patientAddress">
                                <i class="fas fa-map-marker-alt"></i> Dirección *
                            </label>
                            <textarea id="patientAddress" name="direccion" rows="3" required></textarea>
                        </div>

                        <div class="form-group full-width">
                            <label for="patientNotes">
                                <i class="fas fa-sticky-note"></i> Observaciones
                            </label>
                            <textarea id="patientNotes" name="observaciones" rows="3" placeholder="Información adicional relevante"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Registrar Paciente
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('newPatientModal')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Paciente -->
    <div id="viewPatientModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user"></i> Información del Paciente
                </h3>
                <button class="modal-close" onclick="closeModal('viewPatientModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="patient-profile" id="patientProfileContent">
                    <!-- El contenido se carga dinámicamente -->
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="editPatientFromView()">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-success" onclick="scheduleAppointmentFromView()">
                        <i class="fas fa-calendar-plus"></i> Agendar Cita
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Variables globales para pacientes
        let currentUser = null;
        let patients = [];
        let filteredPatients = [];
        let currentPage = 1;
        let patientsPerPage = 10;
        let selectedPatientId = null;

        // Inicializar página de pacientes
        document.addEventListener('DOMContentLoaded', function() {
            initializePatientsPage();
        });

        // Inicializar página
        function initializePatientsPage() {
            if (!checkAuthentication()) return;
            loadUserData();
            setupRoleBasedMenu();
            loadPatients();
            setupPatientForms();
            setupFilters();
        }

        // Verificar autenticación
        function checkAuthentication() {
            const savedUser = localStorage.getItem('otorongo_current_user');
            if (!savedUser) {
                showNotification('Sesión expirada. Redirigiendo al login...', 'warning');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return false;
            }
            currentUser = JSON.parse(savedUser);
            return true;
        }

        // Cargar datos del usuario
        function loadUserData() {
            if (!currentUser) return;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'administrador': 'Administrador',
                'medico': 'Médico',
                'recepcionista': 'Recepcionista'
            };
            return roleNames[role] || role;
        }

        // Configurar menú según rol
        function setupRoleBasedMenu() {
            const menuContainer = document.getElementById('dashboardMenu');
            const menus = {
                'administrador': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes', active: true },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas' },
                    { icon: 'fas fa-file-invoice-dollar', text: 'Facturación', page: 'facturacion' },
                    { icon: 'fas fa-chart-bar', text: 'Reportes', page: 'reportes' }
                ],
                'medico': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Mis Pacientes', page: 'pacientes', active: true },
                    { icon: 'fas fa-calendar-alt', text: 'Mis Citas', page: 'citas' },
                    { icon: 'fas fa-notes-medical', text: 'Historiales', page: 'historiales' }
                ],
                'recepcionista': [
                    { icon: 'fas fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                    { icon: 'fas fa-users', text: 'Pacientes', page: 'pacientes', active: true },
                    { icon: 'fas fa-calendar-alt', text: 'Citas', page: 'citas' },
                    { icon: 'fas fa-file-invoice', text: 'Facturación', page: 'facturacion' }
                ]
            };

            const userMenu = menus[currentUser.role] || menus['recepcionista'];
            
            menuContainer.innerHTML = userMenu.map(item => `
                <li>
                    <a href="${item.page}.html" class="nav-item ${item.active ? 'active' : ''}">
                        <i class="${item.icon}"></i>
                        <span>${item.text}</span>
                    </a>
                </li>
            `).join('');
        }

        // Cargar pacientes
        function loadPatients() {
            patients = OtorongoSystem.getPatients();
            filteredPatients = [...patients];
            displayPatients();
        }

        // Configurar formularios
        function setupPatientForms() {
            const newForm = document.getElementById('newPatientForm');
            if (newForm) {
                newForm.addEventListener('submit', handleNewPatient);
            }

            // Validación de DNI
            const dniInput = document.getElementById('patientDni');
            if (dniInput) {
                dniInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 8);
                });
            }
        }

        // Configurar filtros
        function setupFilters() {
            const searchInput = document.getElementById('searchPatient');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(applyFilters, 300));
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();
            
            filteredPatients = patients.filter(patient => {
                const fullName = `${patient.nombres} ${patient.apellidos}`.toLowerCase();
                return !searchTerm || 
                    fullName.includes(searchTerm) ||
                    patient.dni.includes(searchTerm) ||
                    patient.telefono.includes(searchTerm);
            });

            currentPage = 1;
            displayPatients();
        }

        // Calcular edad
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Mostrar pacientes en la tabla
        function displayPatients() {
            const tbody = document.getElementById('patientsTableBody');
            const startIndex = (currentPage - 1) * patientsPerPage;
            const endIndex = startIndex + patientsPerPage;
            const pagePatients = filteredPatients.slice(startIndex, endIndex);

            if (pagePatients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-user-times"></i>
                                <p>No se encontraron pacientes</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pagePatients.map(patient => {
                const age = calculateAge(patient.fechaNacimiento);
                
                return `
                    <tr>
                        <td>${patient.dni}</td>
                        <td>${patient.nombres} ${patient.apellidos}</td>
                        <td>${age} años</td>
                        <td>${patient.telefono}</td>
                        <td><span class="badge info">${patient.seguro}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action" onclick="viewPatient('${patient.id}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-success" onclick="scheduleAppointment('${patient.id}')" title="Agendar cita">
                                    <i class="fas fa-calendar-plus"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            generatePagination();
        }

        // Generar paginación
        function generatePagination() {
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
            const paginationContainer = document.getElementById('patientsPagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="pagination-controls">';
            
            if (currentPage > 1) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="btn-pagination active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="btn-pagination" onclick="changePage(${i})">${i}</button>`;
                }
            }

            if (currentPage < totalPages) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            paginationHTML += '</div>';
            paginationContainer.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            displayPatients();
        }

        function changePatientsPerPage() {
            patientsPerPage = parseInt(document.getElementById('patientsPerPage').value);
            currentPage = 1;
            displayPatients();
        }

        // Manejar nuevo paciente
        function handleNewPatient(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const dni = formData.get('dni');
            
            if (patients.some(patient => patient.dni === dni)) {
                showNotification('Ya existe un paciente registrado con este DNI', 'error');
                return;
            }

            const patientData = {
                id: OtorongoSystem.generateId(),
                dni: dni,
                nombres: formData.get('nombres'),
                apellidos: formData.get('apellidos'),
                fechaNacimiento: formData.get('fechaNacimiento'),
                telefono: formData.get('telefono'),
                email: formData.get('email') || '',
                direccion: formData.get('direccion'),
                seguro: formData.get('seguro'),
                observaciones: formData.get('observaciones') || '',
                fechaRegistro: new Date().toISOString().split('T')[0],
                historialMedico: []
            };

            patients.push(patientData);
            OtorongoSystem.savePatients(patients);
            
            loadPatients();
            closeModal('newPatientModal');
            e.target.reset();
            
            showNotification('Paciente registrado correctamente', 'success');
        }

        // Ver detalles del paciente
        function viewPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            selectedPatientId = patientId;
            const age = calculateAge(patient.fechaNacimiento);

            const profileContainer = document.getElementById('patientProfileContent');
            profileContainer.innerHTML = `
                <div class="patient-header">
                    <div class="patient-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="patient-basic-info">
                        <h3>${patient.nombres} ${patient.apellidos}</h3>
                        <p class="patient-dni">DNI: ${patient.dni}</p>
                        <p class="patient-age">${age} años</p>
                    </div>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <label>Fecha de Nacimiento:</label>
                        <span>${OtorongoSystem.formatDate(patient.fechaNacimiento)}</span>
                    </div>
                    <div class="detail-item">
                        <label>Teléfono:</label>
                        <span>${patient.telefono}</span>
                    </div>
                    <div class="detail-item">
                        <label>Email:</label>
                        <span>${patient.email || 'No registrado'}</span>
                    </div>
                    <div class="detail-item">
                        <label>Seguro:</label>
                        <span class="badge info">${patient.seguro}</span>
                    </div>
                    <div class="detail-item full-width">
                        <label>Dirección:</label>
                        <span>${patient.direccion}</span>
                    </div>
                    ${patient.observaciones ? `
                        <div class="detail-item full-width">
                            <label>Observaciones:</label>
                            <span>${patient.observaciones}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            openModal('viewPatientModal');
        }

        // Funciones de acción
        function scheduleAppointment(patientId) {
            localStorage.setItem('preselected_patient', patientId);
            window.location.href = 'citas.html';
        }

        function scheduleAppointmentFromView() {
            scheduleAppointment(selectedPatientId);
        }

        function editPatientFromView() {
            closeModal('viewPatientModal');
            showNotification('Función de editar paciente en desarrollo', 'info');
        }

        function refreshPatients() {
            loadPatients();
            showNotification('Lista de pacientes actualizada', 'success');
        }

        function showNotifications() {
            showNotification('Función de notificaciones en desarrollo', 'info');
        }

        function showProfile() {
            showNotification('Función de perfil en desarrollo', 'info');
        }

        function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                localStorage.removeItem('otorongo_current_user');
                localStorage.removeItem('otorongo_login_time');
                showNotification('Sesión cerrada correctamente', 'success');
                setTimeout(() => window.location.href = 'login.html', 1500);
            }
        }
    </script>

    <style>
        .patient-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .patient-avatar {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .patient-basic-info h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
        }

        .patient-dni {
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .patient-age {
            color: var(--primary-color);
            font-weight: 500;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .detail-item span {
            color: var(--gray-600);
        }

        .btn-action.btn-success {
            color: var(--success-color);
        }

        .btn-action.btn-success:hover {
            background: var(--success-color);
            color: var(--white);
        }

        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }

            .patient-header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</body>
</html>
